<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ğŸ”¥ Flamechat</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main>
    <h1 style="background-color: darkred; color: orange">
      ğŸ”¥ Flamechat - Secure Chatting Community Platform
    </h1>
    <button id="login">Log in</button>
    <button id="signup">Sign up</button>

    <div id="townSquare">
      <h2 id="energyboard" style="color: tan;">Welcome to the Town Square! Send a message to view other messages!âš¡ï¸0 ğŸ”¥0</h2>
      <textarea id="message" placeholder="Type a message... (Shift+Enter = newline)"></textarea>
      <button id="sender">Send Message</button>
      <div id="messages" style="color: white; margin-top: 10px;"></div>
    </div>

    <div id="shopBtns" style="display: none;">
      <button id="adrBtn" style="width: 300px; height: 150px; background-color: red; color: orange;">
        Buy Adrenaline Rush (4 embers) â€” Spam rules become more lenient for you and you only for 10 minutes. Also, every message you send will be written in red.
      </button>
      <button id="emberTicket" style="width: 300px; height: 150px; background-color: red; color: orange; display: none;">
        Buy Ember Lottery Ticket (2 embers) - 10% chance to win 25 embers
      </button>
    </div>

    <br>
    <button id="shop" style="display: none;">View Item Shop</button>

    <button id="plant" style="background-color: chartreuse; color: brown; display: none;">Visit Power Plant</button>
    <div id="power">
      <h2 style="color: brown;">Welcome to the Power Plant</h2>
      <h3 style="color: brown;">Messages whose half-lives have passed appear here.</h3>
      <div id="messages2" style="color: white; margin-top: 10px;"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
let emberTicket = document.getElementById("emberTicket")
let adrUntil = parseFloat(localStorage.getItem("adrUntil")) || 0;
      const firebaseConfig = {
  apiKey: "AIzaSyBUsDxbGq9LvRNSlebdpXpRHnEXAn879Wc",
  authDomain: "flamtoechat-1a663.firebaseapp.com",
  projectId: "flamechat-1a663",
  storageBucket: "flamechat-1a663.appspot.com",
  messagingSenderId: "814137163253",
  appId: "1:814137163253:web:f260269e8770e833b9b4bc",
  measurementId: "G-J0TGKRQQGY"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
      const db = firebase.firestore();
      const usersRef = db.collection("users");
const shopBtns = document.getElementById("shopBtns");
let shopping = false;
let mutedUntil = 0;
const today = new Date().toDateString();
let embers = parseInt(localStorage.getItem("embers")) || 10;
let streak = parseInt(localStorage.getItem("streak")) || 1;
const energyBoard = document.getElementById("energyboard");
const plantBtn = document.getElementById("plant");
const msgInput = document.getElementById("message");
const sendBtn = document.getElementById("sender");
const town = document.getElementById("townSquare");
const power = document.getElementById("power");
const messagesDiv = document.getElementById("messages");
const plantDiv = document.getElementById("messages2");

let currentUser = null;
let energy = 0;
let lastSavedEnergy = 0;
let msgCount = 0;
let atPlant = false;

const statsRef = db.collection("chats").doc("town_square").collection("stats").doc("stats");
const msgsRef  = db.collection("chats").doc("town_square").collection("messages")

const bannedWords = ["fuck","blowjob","dick","pussy","ass","balls","cunt","nigger","nigga","milf","sex","bitch","cock","suck","cum","shit","penis","vulva","vagina","boob","boobs","boobies","cuck","fag","faggot","faggots","67"," 6-7"];

function updateEnergyDisplay(val, val2) {
  energyBoard.textContent = `Welcome to the Town Square! âš¡ï¸${val} ğŸ”¥${val2}`;
}
function setEnergy(val) {
  energy = Math.max(0, val | 0);
  updateEnergyDisplay(energy, embers);
}
function incEnergy(delta) {
  setEnergy(energy + delta);
}
function sanitize(str) { return (str || "").trim(); }
function hasProfanity(str) {
  const low = str.toLowerCase();
  const words = low.split(" ")
  return words.some(w => bannedWords.some(b => w.toLowerCase().includes(b.toLowerCase())));
}
function nowMs() { return Date.now(); }

function parseMessage(raw) {
  let halfLife = null;
  let text = raw;
  const tagStart = text.indexOf("#hl ");
  if (tagStart !== -1) {
    const hashAfter = text.indexOf("#", tagStart + 1);
    const segment = hashAfter !== -1 ? text.slice(tagStart + 1, hashAfter) : text.slice(tagStart + 1);
    text = hashAfter !== -1 ? text.replace(text.slice(tagStart, hashAfter + 1), "") : text.replace(text.slice(tagStart), "");
    const parts = segment.trim().split(/\s+/);
    if (parts[1]) {
      const v = parts[1].toLowerCase();
      if (v.endsWith("h")) halfLife = parseFloat(v) * 60 * 60 * 1000;
      else if (v.endsWith("m")) halfLife = parseFloat(v) * 60 * 1000;
      else if (v.endsWith("s")) halfLife = parseFloat(v) * 1000;
      else halfLife = parseFloat(v) * 1000;
    }
  }
  return [[], sanitize(text), halfLife];
}

setInterval(() => {
  if (energy !== lastSavedEnergy) {
    statsRef.set({ energy }, { merge: true });
    lastSavedEnergy = energy;
  }
}, 10000);

statsRef.onSnapshot(snap => {
  const serverEnergy = (snap.exists && typeof snap.data().energy === "number") ? snap.data().energy : 0;
  setEnergy(serverEnergy);
  lastSavedEnergy = serverEnergy;
});

document.getElementById("signup").addEventListener("click", async () => {
  try {
    const email = prompt("Enter email:");
    const password = prompt("Enter password:");
    const username = prompt("Enter username:");
    if (!email || !password || !username) return;

    const cred = await auth.createUserWithEmailAndPassword(email, password);
    const uid = cred.user.uid;
    const allUsers = await usersRef.get();
    const rank = allUsers.size === 0 ? "Head Admin" : "Member";

    await usersRef.doc(uid).set({
      email, username, rank, warnings: 0, banned: false, mutedUntil: 0, adrUntil: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("âœ… Signed up as " + username);
  } catch (err) {
    alert("âŒ " + err.message);
  }
});

document.getElementById("login").addEventListener("click", async () => {
  try {
    const email = prompt("Enter email:");
    const password = prompt("Enter password:");
    if (!email || !password) return;

    await auth.signInWithEmailAndPassword(email, password);
    const uid = auth.currentUser.uid;
    const doc = await usersRef.doc(uid).get();
    if (!doc.exists) throw new Error("User profile not found. Please sign up again.");

    currentUser = { uid, ...doc.data() };
    mutedUntil = currentUser.mutedUntil || 0;

    alert("âœ… Logged in as " + currentUser.username);
    document.getElementById("signup").style.display = "none";
    document.getElementById("login").style.display = "none";
    town.style.display = "block";
    adrUntil = parseFloat(localStorage.getItem("adrUntil"))||currentUser.adrUntil||0
    document.getElementById("shop").style.display = "block";
    if ((currentUser.rank || "").includes("Admin")) plantBtn.style.display = "block";
  } catch (err) {
    alert("âŒ " + err.message);
  }
});

async function sendMessage() {
  const textRaw = sanitize(msgInput.value);
  if (!textRaw) return;
  if (!auth.currentUser) return alert("âŒ Please log in first");

  const userDoc = await usersRef.doc(auth.currentUser.uid).get();
  if (!userDoc.exists) return alert("âŒ User profile missing");
  const user = userDoc.data();
     mutedUntil = user.mutedUntil || 0
    if (mutedUntil > Date.now()) {
    alert("ğŸš« You are muted.");
    return;
  }
   if (textRaw.startsWith("/mute") && user.rank.includes("Admin")) {
  const args = textRaw.trim().split(/\s+/);
  
  if (args.length < 4) {
    alert("âš ï¸ Usage: /mute [username] [reason] [duration in minutes]");
    return;
  }

  const target = args[1];
  const reason = args.slice(2, -1).join(" ");
  const durationStr = args[args.length - 1];
  const duration = parseInt(durationStr);

  if (isNaN(duration) || duration <= 0) {
    alert("âŒ Invalid duration.");
    return;
  }

  if (target.toLowerCase() === "thefirewarder") {
    alert("ğŸš« You cannot mute Thefirewarder.");
    return;
  }

  muteOnCommand(target, reason, duration);
  return;
}
    else if(textRaw.startsWith("/ban")&&textRaw.split(" ").length === 3 && user.rank === "Head Admin"){
      const textWords = textRaw.split(" ")
      banOnCommand(textWords[1],textWords[2])
    }
  if (user.banned) return alert("ğŸš« You are banned.");

  if (hasProfanity(textRaw)) {
    warn(auth.currentUser.uid, "Use of banned words");
    return;
  }

  let [recipients, text, halfLife] = parseMessage(textRaw);
  const words = text.split(/\s+/).filter(Boolean);
   adrUntil = parseFloat(localStorage.getItem("adrUntil")) || adrUntil;
  const singleLim = (adrUntil > Date.now()) ? 60 : 45;
  const msgLim = (adrUntil > Date.now()) ? 2000 : 550;
  const countLim = (adrUntil > Date.now()) ? 15 : 10;
  const msgLim2 = (adrUntil > Date.now()) ? 100 : 75;
  const countLim2 = (adrUntil > Date.now()) ? 5 : 3;

  const tooLongSingle = (words.length === 1 && words[0].length > singleLim);
  const anyWordTooLong = (words.length > 1 && words.some(w => w.length > 30));
  const tooLongMsg = text.length > msgLim;

  await msgsRef.add({
    halfLife: halfLife || null,
    recipients,
    text,
    username: user.username,
    rank: user.rank,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  grantDailyEmbers();
  incEnergy(1);
  msgCount++;

  if (tooLongSingle || anyWordTooLong) {
    await deleteLastNMessages(user.username, 1);
    warn(auth.currentUser.uid, "use of nonsense words for spammy purposes");
    msgCount = 0;
  } else if (tooLongMsg) {
    await deleteLastNMessages(user.username, 10);
    warn(auth.currentUser.uid, "sending a likely spammy message");
    msgCount = 0;
  } else if (msgCount >= countLim2 && text.length > msgLim2) {
    await deleteLastNMessages(user.username, 3);
    warn(auth.currentUser.uid, "sending many large messages quickly");
    msgCount = 0;
  } else if (msgCount >= countLim) {
    await deleteLastNMessages(user.username, 10);
    warn(auth.currentUser.uid, "flooding the chat");
    msgCount = 0;
  }

  msgInput.value = "";
}

async function deleteLastNMessages(username, n) {
  incEnergy(-n);
  const snap = await msgsRef.orderBy("createdAt", "desc").limit(200).get();
  const userMsgs = snap.docs.filter(d => (d.data().username === username)).slice(0, n);
  if (userMsgs.length === 0) return;

  const batch = db.batch();
  userMsgs.forEach(d => batch.delete(d.ref));
  await batch.commit();
}

sendBtn.addEventListener("click", sendMessage);
window.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

setInterval(() => { msgCount = 0; }, 60000);

plantBtn.addEventListener("click", () => {
  atPlant = !atPlant;
  plantBtn.textContent = atPlant ? "Go back to town" : "Visit Power Plant";
  town.style.display = atPlant ? "none" : "block";
  power.style.display = atPlant ? "block" : "none";
});

function renderTown(messages) {
  messagesDiv.innerHTML = "";
  messages.forEach(m => {
    const p = document.createElement("p");
    if(currentUser && m.username === currentUser.username && currentUser.adrUntil > Date.now()){
      p.style.color = "red"
    }
    const ts = m.createdAt?.toDate ? m.createdAt.toDate() : null;
    const when = ts ? ` Â· ${ts.toLocaleString()}` : "";
    p.innerHTML = `<strong>${m.username}</strong> <em>(${m.rank || "Member"})</em>${when}<br>${escapeHtml(m.text || "")}`;
    messagesDiv.insertBefore(p,messagesDiv.firstChild);
  });
}

function renderPlant(messages) {
  plantDiv.innerHTML = "";
  messages.forEach(m => {
    const p = document.createElement("p");
    const ts = m.createdAt?.toDate ? m.createdAt.toDate() : null;
    const when = ts ? ` Â· ${ts.toLocaleString()}` : "";
    const hl = m.halfLife ? ` Â· half-life ${Math.round(m.halfLife/1000)}s` : "";
    p.innerHTML = `<strong>${m.username}</strong> <em>(${m.rank || "Member"})</em>${when}${hl}<br>${escapeHtml(m.text || "")}`;
    plantDiv.appendChild(p);
  });
}

function escapeHtml(s) {
  return s.replace(/[&<>"']/g, c => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c]));
}

msgsRef.orderBy("createdAt", "asc").onSnapshot(snap => {
  const all = [];
  snap.forEach(d => all.push({ id: d.id, ...d.data() }));
  const now = nowMs();
  const townMsgs = [], plantMsgs = [];
  for (const m of all) {
    const created = m.createdAt?.toMillis ? m.createdAt.toMillis() : null;
    if (m.halfLife && created) {
      const age = now - created;
      if (age >= m.halfLife) plantMsgs.push(m);
      else townMsgs.push(m);
    } else townMsgs.push(m);
  }
  renderTown(townMsgs);
  renderPlant(plantMsgs);
});

function grantDailyEmbers() {
  const today = new Date().toDateString();
  const storedLastLogin = localStorage.getItem("lastLogin") || "";

  if (storedLastLogin !== today) {
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    streak = (storedLastLogin === yesterday) ? streak + 1 : 1;
    const reward = 2 ** (streak - 1);
    embers += reward;
    updateEnergyDisplay(energy, embers);
    localStorage.setItem("streak", streak);
    localStorage.setItem("embers", embers);
    localStorage.setItem("lastLogin", today);
  }
}


async function warn(uid, reason) {
  const userRef = usersRef.doc(uid);
  const userSnap = await userRef.get();
  if (!userSnap.exists) return;
  const data = userSnap.data();
  let warnings = (data.warnings || 0) + 1;
  let muteMsg = "";
  if (warnings % 3 === 0) {
    const duration = 10 * warnings * 60 * 1000;
    mutedUntil = Date.now() + duration;
    muteMsg = `Muted for ${10 * warnings} minutes.`;
  }
  await userRef.update({ warnings, mutedUntil });
  await msgsRef.add({
    username: "ğŸ§‘â€âš–ï¸ Town Judge",
    rank: "Bot",
    text: `${data.username} received a warning (${reason}). ${muteMsg}`,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
  });
}

document.getElementById("shop").addEventListener("click", function() {
  shopping = !shopping;
  document.getElementById("shop").innerHTML = shopping ? "Return to Town Square" : "View Item Shop";
  town.style.display = shopping ? "none" : "block";
  shopBtns.style.display = shopping ? "block" : "none";
});

document.getElementById("adrBtn").addEventListener("click", async function() {
  if (embers >= 4) {
    embers -= 4;
    updateEnergyDisplay(energy, embers);
    localStorage.setItem("embers", embers.toString());
    adrUntil = Date.now() + (10 * 60 * 1000);
    localStorage.setItem("adrUntil", adrUntil);
    await usersRef.doc(currentUser.uid).update({ adrUntil });
    currentUser.adrUntil = adrUntil; 
    await msgsRef.add({
      username: "ğŸª Shopkeeper",
      rank: "Bot",
      text: `${currentUser.username} just bought an Adrenaline Rush! ğŸ¢`,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    });
  } else {
    alert("Not enough embers!");
  }
});
emberTicket.addEventListener("click",function(){
  
})
  async function muteOnCommand(username, reason, duration) {
  const userQuery = await usersRef.where("username", "==", username).limit(1).get();
  if (userQuery.empty) {
    alert("âŒ User not found");
    return;
  }

  const userDoc = userQuery.docs[0];
  const userRef = userDoc.ref;
  const data = userDoc.data();
  const warnings = (data.warnings || 0) + 1;
  const mutedUntil = Date.now() + (duration * 60000);

  await userRef.update({ warnings, mutedUntil });

  await msgsRef.add({
    username: "System",
    rank: "Bot",
    text: `${username} has been muted by an anonymous admin for ${duration} minutes for ${reason}`,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
  })
}
 async function banOnCommand(username, reason) {
  const userQuery = await usersRef.where("username", "==", username).limit(1).get();
  if (userQuery.empty) {
    alert("âŒ User not found");
    return;
  }

  const userDoc = userQuery.docs[0];
  const userRef = userDoc.ref;
  const data = userDoc.data();
 await userRef.update({banned: true})

  await msgsRef.add({
    username: "System",
    rank: "Bot",
    text: `${username} has been permanently banned by THefirewarder for ${reason}`,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
  })
 }
</script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background-color: gray;
}
#login, #signup, #sender {
  height: 50px;
  border: none;
  cursor: pointer;
}
#login {
  width: 383px; background-color: darkred; color: red;
}
#login:hover { background-color: salmon; color: darkred; }
#signup {
  width: 383px; background-color: salmon; color: darkred;
}
#signup:hover { background-color: darkred; color: red; }
#sender, #shop {
  width: 140px; height: 40px; background-color: darkred; color: red;
}
#sender:hover, #shop:hover { background-color: salmon; color: darkred; }
#townSquare { display: none; background-color: brown; padding: 10px; }
#power { display: none; background-color: chartreuse; padding: 10px; }
#message {
  width: 100%; max-width: 700px; min-height: 80px; padding: 8px; box-sizing: border-box;
}
</style>
</main>
</body>
</html>
