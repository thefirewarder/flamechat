<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>üî• Flamechat</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main>
      <h1 style="background-color: darkred; color: orange">
        üî• Flamechat - Secure Chatting Community Platform
      </h1>
      <button id="login">Log in</button>
      <button id="signup">Sign up</button>

      <div id="townSquare">
        <h2 id="energyboard" style="color: tan;">Welcome to the Town Square! The town currently has 0 energy.</h2>
        <textarea id="message" placeholder="Type a message..."></textarea>
        <button id="sender">Send Message</button>
        <div id="messages" style="color: white; margin-top: 10px;"></div>
      </div>
      <button id="plant" style="background-color: chartreuse; color: brown; display: none;">Visit Power Plant</button>
      <div id="power">
        <h2 style="color: brown;">Welcome to the Power Plant</h2>
        <h3 style="color: brown;">Messages whose half lives have passed will appear here.</h3>
        <div id="messages2" style="color: white; margin-top: 10px;"></div>
      </div>

      <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

      <script>
const firebaseConfig = {
  apiKey: "AIzaSyBUsDxbGq9LvRNSlebdpXpRHnEXAn879Wc",
  authDomain: "flamechat-1a663.firebaseapp.com",
  projectId: "flamechat-1a663",
  storageBucket: "flamechat-1a663.appspot.com",
  messagingSenderId: "814137163253",
  appId: "1:814137163253:web:f260269e8770e833b9b4bc",
  measurementId: "G-J0TGKRQQGY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const statsRef = db.collection("chats").doc("town_square").collection("stats").doc("stats");
const energyBoard = document.getElementById("energyboard");
let energy = 0;
let lastSavedEnergy = 0;
let msgCount = 0;
let townMessages = [];
let atPlant = false;
const plant = document.getElementById("plant");
const bannedWords = ["fuck","blowjob","dick","pussy","ass","balls","cunt","nigger","nigga","milf","sex","bitch","cock","suck","cum","shit","penis","vulva","vagina","boob","boobs","boobies"];
let currentUser = null;
statsRef.get().then(doc => {
  if (doc.exists && doc.data().energy !== undefined) {
    energy = doc.data().energy;
  } else {
    energy = 0;
  }
  energyBoard.textContent = "Welcome to Town Square! ‚ö°Ô∏è" + energy;
}).catch(err => {
  energyBoard.textContent = "Welcome to Town Square! ‚ö°Ô∏è0";
});
function updateEnergy(newValue) {
  energy = newValue;
  energyBoard.textContent = "Welcome to Town Square! ‚ö°Ô∏è" + energy;
}
setInterval(() => {
  if (energy !== lastSavedEnergy) {
    statsRef.set({ energy: energy }, { merge: true });
    lastSavedEnergy = energy;
  }
}, 10000);
document.getElementById("signup").addEventListener("click", () => {
  const email = prompt("Enter email:");
  const password = prompt("Enter password:");
  const username = prompt("Enter username:");
  auth.createUserWithEmailAndPassword(email, password)
    .then(userCred => {
      const uid = userCred.user.uid;
      return db.collection("users").get().then(snapshot => {
        let rank = "Member";
        if (snapshot.size === 0) rank = "Head Admin";
        return db.collection("invites").doc(uid).set({
          email, username, rank, warnings: 0, banned: false
        });
      });
    })
    .then(() => alert("‚úÖ Signed up as " + username))
    .catch(err => alert("‚ùå " + err.message));
});
document.getElementById("login").addEventListener("click", () => {
  const email = prompt("Enter email:");
  const password = prompt("Enter password:");
  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      const uid = auth.currentUser.uid;
      return db.collection("users").doc(uid).get();
    })
    .then(doc => {
      if (doc.exists) {
        currentUser = doc.data();
        currentUser.uid = auth.currentUser.uid;
        alert("‚úÖ Logged in as " + currentUser.username);
        document.getElementById("signup").style.display = "none";
        document.getElementById("login").style.display = "none";
        document.getElementById("townSquare").style.display = "block";
        if (currentUser.rank.includes("Admin")) plant.style.display = "block";
      }
    })
    .catch(err => alert("‚ùå " + err.message));
});
document.getElementById("sender").addEventListener("click", () => {
  const text = document.getElementById("message").value.trim();
  if (text === "") return;
  const user = auth.currentUser;
  if (!user) return alert("‚ùå Please log in first");
  const uid = user.uid;
  db.collection("users").doc(uid).get().then(doc => {
    if (doc.exists) {
      const userData = doc.data();
      const username = userData.username;
      const rank = userData.rank;
      let [recipients, text1, halfLife] = parseMessage(text);
      db.collection("chats").doc("town_square").collection("messages").add({
        halfLife, recipients, text: text1, username, rank,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      updateEnergy(energy + 1);
      msgCount++;
      const words = doc.data.text1.split(" ")
      if(words.length === 1 && words[0].length < 45 ||words.length > 1 && words.some(word => {
        return word.length > 15
      })){
        deleteLastMessage(username)
        db.collection("chats").doc("town_square").collection("messages").add({
          username: "üßπüë¥üèª Spam Janitor",
          rank: "Bot",
          text: `${username}, WHY ARE YOU GIVING ME SO MUCH TO CLEAN UP?!`,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        msgCount = 0;
      }
      if(doc.data().text.length > 550){
        deleteLast10Messages(username);
        db.collection("chats").doc("town_square").collection("messages").add({
          username: "üßπüë¥üèª Spam Janitor",
          rank: "Bot",
          text: `${username}, WHY ARE YOU GIVING ME SO MUCH TO CLEAN UP?!`,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        msgCount = 0;
      }
      if(msgCount >= 3 && doc.data().text.length > 75){
        deleteLast3Messages(username);
        db.collection("chats").doc("town_square").collection("messages").add({
          username: "üßπüë¥üèª Spam Janitor",
          rank: "Bot",
          text: `${username}, WHY ARE YOU GIVING ME SO MUCH TO CLEAN UP?!`,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        msgCount = 0;
      }
      if (msgCount >= 10) {
        deleteLast10Messages(username);
        db.collection("chats").doc("town_square").collection("messages").add({
          username: "üßπüë¥üèª Spam Janitor",
          rank: "Bot",
          text: `${username}, WHY ARE YOU GIVING ME SO MUCH TO CLEAN UP?!`,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        msgCount = 0;
      }
      document.getElementById("message").value = "";
    }
  });
});
function parseMessage(raw) {
  let recipients = [];
  let halfLife = null;
  let text = raw;
  if (raw.includes("#hl")) {
    const start = raw.indexOf("#hl ");
    if (start !== -1) {
      const end = raw.indexOf("#", start + 1);
      let tagSegment = "";
      if (end !== -1) {
        tagSegment = raw.slice(start + 1, end);
        text = text.replace(raw.slice(start, end + 1), "");
      } else {
        tagSegment = raw.slice(start + 1);
        text = text.replace(raw.slice(start), "");
      }
      const parts = tagSegment.trim().split(" ");
      if (parts[1].toLowerCase().includes("h")) halfLife = parseFloat(parts[1]) * 60 * 60 * 1000;
      else if (parts[1].toLowerCase().includes("m")) halfLife = parseFloat(parts[1]) * 60 * 1000;
      else if (parts[1].toLowerCase().includes("s")) halfLife = parseFloat(parts[1]) * 1000;
      else halfLife = parseFloat(parts[1]) * 1000;
    }
  }
  text = text.trim();
  return [recipients, text, halfLife];
}
plant.addEventListener("click", () => {
  if (!atPlant) {
    plant.innerHTML = "Go back to town";
    atPlant = true;
    document.getElementById("townSquare").style.display = "none";
    document.getElementById("power").style.display = "block";
  } else {
    atPlant = false;
    plant.innerHTML = "Visit Power Plant";
    document.getElementById("townSquare").style.display = "block";
    document.getElementById("power").style.display = "none";
  }
});
setInterval(function(){ msgCount = 0; },60000);
async function deleteLast10Messages(username) {
  updateEnergy(energy-10)
  const snap = await db.collection("chats").doc("town_square").collection("messages").orderBy("createdAt", "desc").get();
  const userMsgs = snap.docs.filter(doc => doc.data().username === username).slice(0, 10);
  const batch = db.batch();
  userMsgs.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
}
        async function deleteLastMessage(username) {
  updateEnergy(energy-1)
  const snap = await db.collection("chats").doc("town_square").collection("messages").orderBy("createdAt", "desc").get();
  const userMsgs = snap.docs.filter(doc => doc.data().username === username).slice(0, 1);
  const batch = db.batch();
  userMsgs.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
}
        async function deleteLast3Messages(username) {
  updateEnergy(energy-3)
  const snap = await db.collection("chats").doc("town_square").collection("messages").orderBy("createdAt", "desc").get();
  const userMsgs = snap.docs.filter(doc => doc.data().username === username).slice(0, 3);
  const batch = db.batch();
  userMsgs.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
}
window.addEventListener("keydown",function(e){
  if(e.key==="Enter"){
    const text = document.getElementById("message").value.trim();
    if (text === "") return;
    const user = auth.currentUser;
    if (!user) return alert("‚ùå Please log in first");
    const uid = user.uid;
    db.collection("users").doc(uid).get().then(doc => {
      if (doc.exists) {
        const userData = doc.data();
        const username = userData.username;
        const rank = userData.rank;
        let [recipients, text1, halfLife] = parseMessage(text);
        db.collection("chats").doc("town_square").collection("messages").add({
          halfLife, recipients, text: text1, username, rank,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        msgCount++;
        if (msgCount >= 10) {
          deleteLast10Messages(currentUser.username);
          db.collection("chats").doc("town_square").collection("messages").add({
            username: "üßπüë¥üèª Spam Janitor",
            rank: "Bot",
            text: `${username}, WHY ARE YOU GIVING ME SO MUCH TO CLEAN UP?!`,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          msgCount = 0;
        }
        document.getElementById("message").value = "";
      }
    });
  }
});
</script>

      <style>
        html, body {
  margin: 0;
  padding: 0;
  background-color: gray;
}
canvas {
  display: block;
}
#login{
  width: 383px;
  height: 50px;
  background-color: darkred;
  color: red;
}
#login:hover{
  width: 383px;
  height: 50px;
    background-color: salmon;
  color: darkred;
}
 #signup{
  width: 383px;
  height: 50px;
    background-color: salmon;
  color: darkred;
}
#signup:hover{
  width: 383px;
  height: 50px;
    background-color: darkred;
  color: red;
}
#sender{
  width: 100px;
  height: 33px;
  background-color: darkred;
  color: red;
}
#sender:hover{
   width: 100px;
  height: 33px;
  background-color: salmon;
  color: darkred;
}
#townSquare{
  display: none;
  background-color: brown;
}
#power{
  display: none;
  background-color: chartreuse;
}

      </style>
    </main>
  </body>
</html>
